import React, { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import jobService from '../../services/jobService';

interface Job {
  jobId: number;
  jobNumber: string;
  fullJobNumber?: string;
  rfqId?: number;
  quoteId?: number;
  isParentJob: boolean;
  billingType?: string;
  creationSource?: string;
  description: string;
  clientId?: number;
  orderReceived?: boolean;
  orderNumber?: string;
  orderDate?: string;
  orderValueExcl?: number;
  orderValueIncl?: number;
  department?: string;
  location?: string;
  supervisor?: string;
  status: string;
  priority: string;
  progressPercentage: number;
  startDate?: string;
  expectedCompletionDate?: string;
  actualCompletionDate?: string;
  invoiceNumber?: string;
  invoiceDate?: string;
  invoiceAmount?: number;
  notes?: string;
  createdBy?: string;
  createdDate?: string;
  lastModifiedBy?: string;
  lastModifiedDate?: string;
}

interface ChildJob {
  jobId: number;
  jobNumber: string;
  description: string;
  department?: string;
  location?: string;
  status: string;
  priority: string;
  progressPercentage: number;
}

interface TaskTemplate {
  templateId: number;
  templateName: string;
  description: string;
  department: string;
  estimatedTotalHours: number;
  isActive: boolean;
  tasks: TemplateTask[];
}

interface TemplateTask {
  templateTaskId: number;
  sequenceNumber: number;
  description: string;
  estimatedHours: number;
  assignedTo: string;
  notes?: string;
}

export default function JobDetail() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();

  const [job, setJob] = useState<Job | null>(null);
  const [childJobs, setChildJobs] = useState<ChildJob[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // Create Child Job Modal State
  const [createDialogOpen, setCreateDialogOpen] = useState(false);
  const [bulkMode, setBulkMode] = useState(false);
  const [applyTemplate, setApplyTemplate] = useState(false);
  const [childJobDescription, setChildJobDescription] = useState('');
  const [childJobLocation, setChildJobLocation] = useState('');
  const [childJobDepartment, setChildJobDepartment] = useState('');
  const [childJobQuantity, setChildJobQuantity] = useState(5);
  const [selectedTemplateId, setSelectedTemplateId] = useState<number | null>(null);
  const [templates, setTemplates] = useState<TaskTemplate[]>([]);
  const [selectedTemplate, setSelectedTemplate] = useState<TaskTemplate | null>(null);

  useEffect(() => {
    loadJob();
    loadTemplates();
  }, [id]);

  const loadJob = async () => {
    try {
      setLoading(true);
      setError(null);

      const data = await jobService.getJobById(Number(id));
      setJob(data);

      // Load child jobs if this is a parent
      if (data.isParentJob) {
        const children = await jobService.getChildJobs(Number(id));
        setChildJobs(children);
      }

      setLoading(false);
    } catch (err: any) {
      console.error('Error loading job:', err);
      setError(err.message || 'Failed to load job');
      setLoading(false);
    }
  };

  const loadTemplates = async () => {
    try {
      const response = await fetch('http://localhost:8080/api/v1/task-templates');
      if (response.ok) {
        const data = await response.json();
        setTemplates(data);
      }
    } catch (err) {
      console.error('Error loading templates:', err);
    }
  };

  const handleTemplateChange = async (templateId: number) => {
    setSelectedTemplateId(templateId);
    if (templateId) {
      try {
        const response = await fetch(`http://localhost:8080/api/v1/task-templates/${templateId}`);
        if (response.ok) {
          const data = await response.json();
          setSelectedTemplate(data);
        }
      } catch (err) {
        console.error('Error loading template:', err);
      }
    } else {
      setSelectedTemplate(null);
    }
  };

  const handleCreateChildJobs = async () => {
    try {
      if (!childJobDescription.trim()) {
        alert('Please enter a description');
        return;
      }

      const childJobsData = [];

      if (bulkMode && childJobQuantity > 1) {
        // Create multiple child jobs with auto-numbering
        for (let i = 1; i <= childJobQuantity; i++) {
          const suffix = i.toString().padStart(2, '0');
          childJobsData.push({
            description: `${childJobDescription} #${suffix}`,
            location: childJobLocation || job?.location || '',
            department: childJobDepartment || job?.department || '',
          });
        }
      } else {
        // Create single child job
        childJobsData.push({
          description: childJobDescription,
          location: childJobLocation || job?.location || '',
          department: childJobDepartment || job?.department || '',
        });
      }

      // Create child jobs
      const response = await fetch(`http://localhost:8080/api/v1/jobs/${id}/children`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(childJobsData)
      });

      if (!response.ok) {
        throw new Error('Failed to create child jobs');
      }

      const createdJobs = await response.json();

      // If template is selected, apply tasks to all child jobs
      if (applyTemplate && selectedTemplate && selectedTemplate.tasks) {
        for (const createdJob of createdJobs) {
          const tasks = selectedTemplate.tasks.map(task => ({
            description: task.description,
            estimatedHours: task.estimatedHours,
            assignedTo: task.assignedTo,
            notes: task.notes || '',
            status: 'PENDING'
          }));

          await fetch(`http://localhost:8080/api/v1/jobs/${createdJob.jobId}/tasks`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(tasks)
          });
        }
      }

      alert(
          bulkMode
              ? `Successfully created ${childJobQuantity} child jobs${applyTemplate ? ' with tasks' : ''}!`
              : `Successfully created child job${applyTemplate ? ' with tasks' : ''}!`
      );

      resetDialog();
      setCreateDialogOpen(false);
      loadJob(); // Reload to show new children
    } catch (err: any) {
      console.error('Error creating child jobs:', err);
      alert(err.message || 'Failed to create child jobs');
    }
  };

  const resetDialog = () => {
    setChildJobDescription('');
    setChildJobLocation('');
    setChildJobDepartment('');
    setChildJobQuantity(5);
    setBulkMode(false);
    setApplyTemplate(false);
    setSelectedTemplateId(null);
    setSelectedTemplate(null);
  };

  const getStatusBadgeClass = (status: string) => {
    const classes: Record<string, string> = {
      'NEW': 'badge bg-primary',
      'IN_PROGRESS': 'badge bg-info',
      'COMPLETE': 'badge bg-success',
      'COMPLETED': 'badge bg-success',
      'INVOICED': 'badge bg-success',
      'ON_HOLD': 'badge bg-warning',
      'CANCELLED': 'badge bg-danger',
      'DELIVERED': 'badge bg-success',
    };
    return classes[status] || 'badge bg-secondary';
  };

  const getPriorityBadgeClass = (priority: string) => {
    const classes: Record<string, string> = {
      'LOW': 'badge bg-info',
      'MEDIUM': 'badge bg-warning',
      'HIGH': 'badge bg-danger',
      'URGENT': 'badge bg-danger',
    };
    return classes[priority] || 'badge bg-secondary';
  };

  if (loading) {
    return (
        <div className="d-flex justify-content-center align-items-center" style={{ minHeight: '80vh' }}>
          <div className="spinner-border text-primary" role="status">
            <span className="visually-hidden">Loading...</span>
          </div>
        </div>
    );
  }

  if (error) {
    return (
        <div className="container mt-4">
          <div className="alert alert-danger">{error}</div>
          <button className="btn btn-primary" onClick={() => navigate('/jobs')}>
            ← Back to Jobs
          </button>
        </div>
    );
  }

  if (!job) {
    return (
        <div className="container mt-4">
          <div className="alert alert-warning">Job not found</div>
          <button className="btn btn-primary" onClick={() => navigate('/jobs')}>
            ← Back to Jobs
          </button>
        </div>
    );
  }

  return (
      <div className="min-vh-100" style={{ background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' }}>
        {/* Header */}
        <div className="container-fluid px-4 py-4">
          <div className="d-flex justify-content-between align-items-center mb-4">
            <div className="d-flex align-items-center gap-3">
              <button
                  onClick={() => navigate('/jobs')}
                  className="btn btn-light"
                  style={{ borderRadius: '8px' }}
              >
                ← Back to Jobs
              </button>
              <div>
                <h1 className="text-white fw-bold mb-1">
                  📋 Job: {job.jobNumber}
                </h1>
                <p className="text-white-50 mb-0">Master Job Card - ERHA Operations</p>
              </div>
            </div>
            <div className="d-flex gap-2">
              <button
                  onClick={() => navigate(`/jobs/${job.jobId}/edit`)}
                  className="btn btn-warning fw-semibold"
                  style={{ borderRadius: '8px' }}
              >
                ✏️ Edit Job
              </button>
              <button
                  className="btn btn-light fw-semibold"
                  style={{ borderRadius: '8px' }}
              >
                📄 Generate PDF
              </button>
              <button
                  onClick={() => setCreateDialogOpen(true)}
                  className="btn btn-success fw-semibold"
                  style={{ borderRadius: '8px' }}
              >
                ➕ Create Child Job
              </button>
            </div>
          </div>
        </div>

        <div className="container-fluid px-4 pb-4">
          <div className="row g-4">
            {/* Left Column - Main Content */}
            <div className="col-lg-8">
              {/* Job Information Card */}
              <div className="card shadow-sm mb-4" style={{ borderRadius: '12px' }}>
                <div className="card-header bg-dark text-white">
                  <h5 className="mb-0">🔧 Job Information</h5>
                </div>
                <div className="card-body">
                  <div className="row g-3">
                    <div className="col-md-6">
                      <label className="text-muted small">Job Number</label>
                      <div className="fw-bold">{job.jobNumber}</div>
                    </div>
                    <div className="col-md-6">
                      <label className="text-muted small">Order Number</label>
                      <div>{job.orderNumber || 'Not assigned'}</div>
                    </div>
                    <div className="col-md-6">
                      <label className="text-muted small">Department</label>
                      <div>{job.department}</div>
                    </div>
                    <div className="col-md-6">
                      <label className="text-muted small">Location</label>
                      <div>{job.location}</div>
                    </div>
                    <div className="col-12">
                      <label className="text-muted small">Description</label>
                      <div>{job.description}</div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Status & Priority */}
              <div className="card shadow-sm mb-4" style={{ borderRadius: '12px' }}>
                <div className="card-header" style={{ background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: 'white' }}>
                  <h5 className="mb-0">📊 Status & Priority</h5>
                </div>
                <div className="card-body">
                  <div className="row g-3">
                    <div className="col-md-4">
                      <label className="text-muted small">Status</label>
                      <div>
                        <span className={getStatusBadgeClass(job.status)}>{job.status}</span>
                      </div>
                    </div>
                    <div className="col-md-4">
                      <label className="text-muted small">Priority</label>
                      <div>
                        <span className={getPriorityBadgeClass(job.priority)}>{job.priority}</span>
                      </div>
                    </div>
                    <div className="col-md-4">
                      <label className="text-muted small">Progress</label>
                      <div className="progress" style={{ height: '25px' }}>
                        <div
                            className="progress-bar bg-info"
                            role="progressbar"
                            style={{ width: `${job.progressPercentage || 0}%` }}
                        >
                          {job.progressPercentage || 0}%
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Source RFQ */}
              {job.rfqId && (
                  <div className="card shadow-sm mb-4" style={{ borderRadius: '12px' }}>
                    <div className="card-header bg-info text-white">
                      <h5 className="mb-0">📝 Source RFQ</h5>
                    </div>
                    <div className="card-body">
                      <p className="mb-2">This job was created from RFQ:</p>
                      <div className="d-flex justify-content-between align-items-center">
                        <div className="fw-bold">RFQ #{job.rfqId}</div>
                        <button
                            onClick={() => navigate(`/rfq/${job.rfqId}`)}
                            className="btn btn-info btn-sm"
                        >
                          View RFQ →
                        </button>
                      </div>
                    </div>
                  </div>
              )}

              {/* Supervisor Job Planning Info */}
              <div className="card shadow-sm mb-4" style={{ borderRadius: '12px' }}>
                <div className="card-header bg-warning">
                  <h5 className="mb-0">📅 Supervisor Job Planning Info</h5>
                </div>
                <div className="card-body">
                  <div className="row text-center g-2">
                    <div className="col-3">
                      <label className="text-muted small">Date Received</label>
                      <div className="fw-semibold">Not set</div>
                    </div>
                    <div className="col-3">
                      <label className="text-muted small">Material Ordered</label>
                      <div className="fw-semibold">Not ordered</div>
                    </div>
                    <div className="col-3">
                      <label className="text-muted small">Completion Date</label>
                      <div className="fw-semibold">Not set</div>
                    </div>
                    <div className="col-3">
                      <label className="text-muted small text-danger">Due Date</label>
                      <div className="fw-semibold text-danger">Not set</div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Task Checklist */}
              <div className="card shadow-sm mb-4" style={{ borderRadius: '12px' }}>
                <div className="card-header bg-primary text-white">
                  <h5 className="mb-0">✅ Task Checklist</h5>
                </div>
                <div className="card-body">
                  <div className="alert alert-info">
                    <strong>📝 Note:</strong> Task management coming soon. This will include:
                    <ul className="mb-0 mt-2">
                      <li>Manufacture tasks</li>
                      <li>Sandblast operations</li>
                      <li>Material preparation</li>
                      <li>Quality checks</li>
                      <li>Progress tracking</li>
                    </ul>
                  </div>
                </div>
              </div>

              {/* Child Jobs Table */}
              {childJobs.length > 0 && (
                  <div className="card shadow-sm mb-4" style={{ borderRadius: '12px' }}>
                    <div className="card-header bg-success text-white">
                      <h5 className="mb-0">👶 Child Jobs ({childJobs.length})</h5>
                    </div>
                    <div className="card-body">
                      <div className="table-responsive">
                        <table className="table table-hover">
                          <thead>
                          <tr>
                            <th>Job Number</th>
                            <th>Description</th>
                            <th>Department</th>
                            <th>Status</th>
                            <th>Priority</th>
                            <th>Progress</th>
                          </tr>
                          </thead>
                          <tbody>
                          {childJobs.map(child => (
                              <tr
                                  key={child.jobId}
                                  onClick={() => navigate(`/jobs/${child.jobId}`)}
                                  style={{ cursor: 'pointer' }}
                              >
                                <td className="fw-bold text-primary">{child.jobNumber}</td>
                                <td>{child.description}</td>
                                <td>{child.department}</td>
                                <td><span className={getStatusBadgeClass(child.status)}>{child.status}</span></td>
                                <td><span className={getPriorityBadgeClass(child.priority)}>{child.priority}</span></td>
                                <td>{child.progressPercentage}%</td>
                              </tr>
                          ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
              )}
            </div>

            {/* Right Column - Sidebar */}
            <div className="col-lg-4">
              {/* Important Dates */}
              <div className="card shadow-sm mb-4" style={{ borderRadius: '12px' }}>
                <div className="card-header bg-success text-white">
                  <h5 className="mb-0">📅 Important Dates</h5>
                </div>
                <div className="card-body">
                  <div className="mb-3">
                    <label className="text-muted small">Start Date</label>
                    <div>{job.startDate || 'Not set'}</div>
                  </div>
                  <div className="mb-3">
                    <label className="text-muted small text-danger">Due Date</label>
                    <div className="text-danger">{job.expectedCompletionDate || 'Not set'}</div>
                  </div>
                  <div className="mb-3">
                    <label className="text-muted small">Completion Date</label>
                    <div>{job.actualCompletionDate || 'Not set'}</div>
                  </div>
                  <div>
                    <label className="text-muted small">Created</label>
                    <div>{job.createdDate || 'Not set'}</div>
                  </div>
                </div>
              </div>

              {/* Quick Actions */}
              <div className="card shadow-sm" style={{ borderRadius: '12px' }}>
                <div className="card-header bg-dark text-white">
                  <h5 className="mb-0">⚡ Quick Actions</h5>
                </div>
                <div className="card-body">
                  <div className="d-grid gap-2">
                    <button
                        onClick={() => navigate(`/jobs/${job.jobId}/edit`)}
                        className="btn btn-outline-primary"
                    >
                      ✏️ Edit Job Details
                    </button>
                    <button className="btn btn-outline-info">
                      📄 Download Job Card PDF
                    </button>
                    <button
                        onClick={() => setCreateDialogOpen(true)}
                        className="btn btn-outline-success"
                    >
                      ➕ Create Child Job
                    </button>
                    {job.rfqId && (
                        <button
                            onClick={() => navigate(`/rfq/${job.rfqId}`)}
                            className="btn btn-outline-secondary"
                        >
                          📝 View Source RFQ
                        </button>
                    )}
                    <button
                        onClick={() => navigate('/jobs')}
                        className="btn btn-outline-dark"
                    >
                      ← Back to All Jobs
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Create Child Job Modal */}
        {createDialogOpen && (
            <div className="modal show d-block" style={{ backgroundColor: 'rgba(0,0,0,0.5)' }}>
              <div className="modal-dialog modal-lg modal-dialog-centered">
                <div className="modal-content">
                  <div className="modal-header bg-success text-white">
                    <h5 className="modal-title">➕ Create Child Job</h5>
                    <button
                        type="button"
                        className="btn-close btn-close-white"
                        onClick={() => {
                          setCreateDialogOpen(false);
                          resetDialog();
                        }}
                    ></button>
                  </div>
                  <div className="modal-body">
                    <div className="mb-3">
                      <label className="form-label fw-bold">Job Description *</label>
                      <input
                          type="text"
                          className="form-control"
                          placeholder="Enter child job description..."
                          value={childJobDescription}
                          onChange={(e) => setChildJobDescription(e.target.value)}
                      />
                    </div>

                    <div className="row g-3 mb-3">
                      <div className="col-md-6">
                        <label className="form-label">Location</label>
                        <select
                            className="form-select"
                            value={childJobLocation}
                            onChange={(e) => setChildJobLocation(e.target.value)}
                        >
                          <option value="">Same as parent ({job.location})</option>
                          <option value="SHOP">SHOP</option>
                          <option value="SITE">SITE</option>
                        </select>
                      </div>
                      <div className="col-md-6">
                        <label className="form-label">Department</label>
                        <select
                            className="form-select"
                            value={childJobDepartment}
                            onChange={(e) => setChildJobDepartment(e.target.value)}
                        >
                          <option value="">Same as parent ({job.department})</option>
                          <option value="MACHINING">MACHINING</option>
                          <option value="FABRICATION">FABRICATION</option>
                          <option value="ASSEMBLY">ASSEMBLY</option>
                        </select>
                      </div>
                    </div>

                    <div className="card bg-light mb-3">
                      <div className="card-body">
                        <div className="form-check mb-2">
                          <input
                              className="form-check-input"
                              type="checkbox"
                              id="bulkMode"
                              checked={bulkMode}
                              onChange={(e) => setBulkMode(e.target.checked)}
                          />
                          <label className="form-check-label" htmlFor="bulkMode">
                            <strong>Create multiple child jobs</strong>
                            <div className="small text-muted">Auto-number multiple jobs (e.g., Job #01, Job #02...)</div>
                          </label>
                        </div>

                        {bulkMode && (
                            <div className="mt-3">
                              <label className="form-label">How many child jobs?</label>
                              <input
                                  type="number"
                                  className="form-control"
                                  min="2"
                                  max="20"
                                  value={childJobQuantity}
                                  onChange={(e) => setChildJobQuantity(parseInt(e.target.value))}
                              />
                              <div className="small text-muted mt-1">
                                Will create: "{childJobDescription} #01", "{childJobDescription} #02", etc.
                              </div>
                            </div>
                        )}
                      </div>
                    </div>

                    <div className="card bg-light">
                      <div className="card-body">
                        <div className="form-check mb-2">
                          <input
                              className="form-check-input"
                              type="checkbox"
                              id="applyTemplate"
                              checked={applyTemplate}
                              onChange={(e) => setApplyTemplate(e.target.checked)}
                          />
                          <label className="form-check-label" htmlFor="applyTemplate">
                            <strong>Apply task template</strong>
                            <div className="small text-muted">Add standard tasks to all child jobs</div>
                          </label>
                        </div>

                        {applyTemplate && (
                            <div className="mt-3">
                              <label className="form-label">Select Template</label>
                              <select
                                  className="form-select"
                                  value={selectedTemplateId || ''}
                                  onChange={(e) => handleTemplateChange(parseInt(e.target.value))}
                              >
                                <option value="">-- Select Template --</option>
                                {templates.map(template => (
                                    <option key={template.templateId} value={template.templateId}>
                                      {template.templateName} - {template.department} ({template.estimatedTotalHours}h)
                                    </option>
                                ))}
                              </select>

                              {selectedTemplate && (
                                  <div className="alert alert-info mt-3 mb-0">
                                    <div className="fw-bold">{selectedTemplate.templateName}</div>
                                    <div className="small">{selectedTemplate.description}</div>
                                    <div className="small mt-2">
                                      <strong>Tasks ({selectedTemplate.tasks.length}):</strong>
                                      <ul className="mb-0 mt-1">
                                        {selectedTemplate.tasks.slice(0, 5).map(task => (
                                            <li key={task.templateTaskId}>
                                              {task.description} ({task.estimatedHours}h)
                                            </li>
                                        ))}
                                        {selectedTemplate.tasks.length > 5 && (
                                            <li className="text-muted">
                                              ... and {selectedTemplate.tasks.length - 5} more tasks
                                            </li>
                                        )}
                                      </ul>
                                    </div>
                                  </div>
                              )}
                            </div>
                        )}
                      </div>
                    </div>

                    {(bulkMode || applyTemplate) && (
                        <div className="alert alert-success mt-3 mb-0">
                          <strong>Summary:</strong> Will create{' '}
                          {bulkMode ? childJobQuantity : 1} child job(s)
                          {applyTemplate && selectedTemplate && (
                              <span>
                        {' '}with {selectedTemplate.tasks.length} tasks each
                                {bulkMode && ` (${childJobQuantity * selectedTemplate.tasks.length} tasks total)`}
                      </span>
                          )}
                        </div>
                    )}
                  </div>
                  <div className="modal-footer">
                    <button
                        type="button"
                        className="btn btn-secondary"
                        onClick={() => {
                          setCreateDialogOpen(false);
                          resetDialog();
                        }}
                    >
                      Cancel
                    </button>
                    <button
                        type="button"
                        className="btn btn-success"
                        onClick={handleCreateChildJobs}
                        disabled={!childJobDescription.trim()}
                    >
                      Create {bulkMode ? `${childJobQuantity} Jobs` : 'Job'}
                    </button>
                  </div>
                </div>
              </div>
            </div>
        )}
      </div>
  );
}