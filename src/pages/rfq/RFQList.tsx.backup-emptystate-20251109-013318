// src/pages/rfq/RFQList.tsx
// ERHA OPS - RFQ List with Incoming/Outgoing Tabs
// CLEAN VERSION

import React, { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { Plus, Search, Eye, Edit, Trash2, UserPlus, AlertCircle, Download, Upload } from 'lucide-react';

interface RFQ {
  id: number;
  rfqNumber: string;
  rfqType?: string; // 'INCOMING' or 'OUTGOING'
  clientName: string;
  contactPerson: string;
  projectName: string;
  description: string;
  receivedDate: string;
  requiredBy: string;
  priority: string;
  status: string;
  operatingEntity: string;
  estimatedValue?: number;
  assignedTo?: string;
}

export default function RFQList() {
  const navigate = useNavigate();
  const [rfqs, setRfqs] = useState<RFQ[]>([]);
  const [filteredRfqs, setFilteredRfqs] = useState<RFQ[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // Active tab
  const [activeTab, setActiveTab] = useState<'INCOMING' | 'OUTGOING'>('INCOMING');

  // Filters
  const [searchTerm, setSearchTerm] = useState('');
  const [statusFilter, setStatusFilter] = useState('ALL');
  const [priorityFilter, setPriorityFilter] = useState('ALL');
  const [entityFilter, setEntityFilter] = useState('ALL');

  // Delete modal
  const [deleteModalOpen, setDeleteModalOpen] = useState(false);
  const [rfqToDelete, setRfqToDelete] = useState<RFQ | null>(null);

  // Reassign modal
  const [reassignModalOpen, setReassignModalOpen] = useState(false);
  const [rfqToReassign, setRfqToReassign] = useState<RFQ | null>(null);
  const [newAssignee, setNewAssignee] = useState('');

  useEffect(() => {
    fetchRfqs();
  }, []);

  useEffect(() => {
    filterRfqs();
  }, [rfqs, activeTab, searchTerm, statusFilter, priorityFilter, entityFilter]);

  const fetchRfqs = async () => {
    setLoading(true);
    setError(null);
    try {
      const response = await fetch('http://localhost:8080/api/v1/rfqs');
      if (!response.ok) {
        throw new Error(`Failed to fetch RFQs: ${response.statusText}`);
      }
      const data = await response.json();
      const rfqArray = Array.isArray(data) ? data : (data.content || []);

      // Map backend fields to frontend fields
      const mappedRfqs = rfqArray.map((rfq: any) => ({
        id: rfq.id,
        rfqNumber: rfq.job_no || rfq.jobNo || rfq.rfqNumber || `RFQ-${rfq.id}`,
        rfqType: rfq.rfq_type || rfq.rfqType || 'INCOMING', // Default to INCOMING if not set
        clientName: rfq.client_name || rfq.clientName || 'N/A',
        contactPerson: rfq.contact_person || rfq.contactPerson || 'N/A',
        contactEmail: rfq.contact_email || rfq.contactEmail || '',
        contactPhone: rfq.contact_phone || rfq.contactPhone || '',
        projectName: rfq.project_name || rfq.projectName || rfq.description || 'N/A',
        description: rfq.description || '',
        receivedDate: rfq.request_date || rfq.receivedDate || rfq.received_date,
        requiredBy: rfq.required_date || rfq.requiredBy || rfq.required_by,
        priority: rfq.priority || 'MEDIUM',
        status: rfq.status || 'NEW',
        operatingEntity: rfq.operating_entity || rfq.operatingEntity || 'ERHA FC',
        workLocation: rfq.work_location || rfq.workLocation || 'SHOP',
        estimatedValue: rfq.estimated_value || rfq.estimatedValue,
        assignedTo: rfq.assigned_to || rfq.assignedTo,
        createdAt: rfq.created_at || rfq.createdAt,
        updatedAt: rfq.updated_at || rfq.updatedAt,
      }));

      setRfqs(mappedRfqs);
    } catch (err: any) {
      console.error('Error fetching RFQs:', err);
      setError('Failed to load RFQs. Please ensure backend is running.');
    } finally {
      setLoading(false);
    }
  };

  const filterRfqs = () => {
    let filtered = [...rfqs];

    // Tab filter (INCOMING or OUTGOING)
    filtered = filtered.filter(rfq =>
        (rfq.rfqType || 'INCOMING') === activeTab
    );

    // Search filter
    if (searchTerm) {
      filtered = filtered.filter(rfq =>
          rfq.rfqNumber?.toLowerCase().includes(searchTerm.toLowerCase()) ||
          rfq.clientName?.toLowerCase().includes(searchTerm.toLowerCase()) ||
          rfq.projectName?.toLowerCase().includes(searchTerm.toLowerCase())
      );
    }

    // Status filter
    if (statusFilter !== 'ALL') {
      filtered = filtered.filter(rfq => rfq.status === statusFilter);
    }

    // Priority filter
    if (priorityFilter !== 'ALL') {
      filtered = filtered.filter(rfq => rfq.priority === priorityFilter);
    }

    // Entity filter
    if (entityFilter !== 'ALL') {
      filtered = filtered.filter(rfq => rfq.operatingEntity === entityFilter);
    }

    setFilteredRfqs(filtered);
  };

  const handleDelete = async () => {
    if (!rfqToDelete) return;

    try {
      const response = await fetch(`http://localhost:8080/api/v1/rfqs/${rfqToDelete.id}`, {
        method: 'DELETE',
      });

      if (response.ok) {
        setRfqs(rfqs.filter(r => r.id !== rfqToDelete.id));
        setDeleteModalOpen(false);
        setRfqToDelete(null);
      } else {
        alert('Failed to delete RFQ');
      }
    } catch (err) {
      console.error('Error deleting RFQ:', err);
      alert('Error deleting RFQ');
    }
  };

  const handleReassign = async () => {
    if (!rfqToReassign || !newAssignee.trim()) {
      alert('Please enter an assignee name');
      return;
    }

    try {
      const response = await fetch(`http://localhost:8080/api/v1/rfqs/${rfqToReassign.id}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          assignedTo: newAssignee.trim(),
        }),
      });

      if (response.ok) {
        setRfqs(rfqs.map(r =>
            r.id === rfqToReassign.id
                ? { ...r, assignedTo: newAssignee.trim() }
                : r
        ));
        setReassignModalOpen(false);
        setRfqToReassign(null);
        setNewAssignee('');
      } else {
        alert('Failed to reassign RFQ');
      }
    } catch (err) {
      console.error('Error reassigning RFQ:', err);
      alert('Error reassigning RFQ');
    }
  };

  const openDeleteModal = (rfq: RFQ) => {
    setRfqToDelete(rfq);
    setDeleteModalOpen(true);
  };

  const openReassignModal = (rfq: RFQ) => {
    setRfqToReassign(rfq);
    setNewAssignee(rfq.assignedTo || '');
    setReassignModalOpen(true);
  };

  const getStatusBadge = (status: string) => {
    const badges: { [key: string]: string } = {
      'NEW': 'primary',
      'IN_PROGRESS': 'info',
      'QUOTED': 'success',
      'WON': 'success',
      'LOST': 'danger',
      'CANCELLED': 'secondary',
      'Pending Clarification': 'warning',
      'Completed': 'success'
    };
    return badges[status] || 'secondary';
  };

  const getPriorityBadge = (priority: string) => {
    const badges: { [key: string]: string } = {
      'URGENT': 'danger',
      'HIGH': 'warning',
      'MEDIUM': 'info',
      'Medium': 'info',
      'LOW': 'secondary'
    };
    return badges[priority] || 'secondary';
  };

  // Count RFQs by type
  const incomingCount = rfqs.filter(r => (r.rfqType || 'INCOMING') === 'INCOMING').length;
  const outgoingCount = rfqs.filter(r => (r.rfqType || 'INCOMING') === 'OUTGOING').length;

  if (loading) {
    return (
        <div className="container-fluid">
          <div className="d-flex justify-content-center align-items-center" style={{ minHeight: '400px' }}>
            <div className="spinner-border text-primary" role="status">
              <span className="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
    );
  }

  if (error) {
    return (
        <div className="container-fluid">
          <div className="alert alert-danger">
            <AlertCircle size={20} className="me-2" />
            <strong>Error:</strong> {error}
          </div>
          <button className="btn btn-primary" onClick={fetchRfqs}>
            Try Again
          </button>
        </div>
    );
  }

  return (
      <div className="container-fluid">
        {/* Header */}
        <div className="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h2 className="mb-1">RFQs (Requests for Quotation)</h2>
            <p className="text-muted mb-0">{rfqs.length} total RFQs</p>
          </div>
          <button className="btn btn-primary" onClick={() => navigate('/rfq/create')}>
            <Plus size={16} className="me-2" />
            Create RFQ
          </button>
        </div>

        {/* Tabs */}
        <ul className="nav nav-tabs mb-4">
          <li className="nav-item">
            <button
                className={`nav-link ${activeTab === 'INCOMING' ? 'active' : ''}`}
                onClick={() => setActiveTab('INCOMING')}
            >
              <Download size={16} className="me-2" />
              Incoming RFQs
              <span className="badge bg-primary ms-2">{incomingCount}</span>
            </button>
          </li>
          <li className="nav-item">
            <button
                className={`nav-link ${activeTab === 'OUTGOING' ? 'active' : ''}`}
                onClick={() => setActiveTab('OUTGOING')}
            >
              <Upload size={16} className="me-2" />
              Outgoing RFQs
              <span className="badge bg-success ms-2">{outgoingCount}</span>
            </button>
          </li>
        </ul>

        {/* Tab Description */}
        <div className="alert alert-info mb-4">
          <strong>
            {activeTab === 'INCOMING' ? '📥 Incoming RFQs:' : '📤 Outgoing RFQs:'}
          </strong>{' '}
          {activeTab === 'INCOMING'
              ? 'Requests from clients for ERHA to provide quotes (Client → ERHA)'
              : 'Requests from ERHA to suppliers for quotes (ERHA → Supplier)'}
        </div>

        {/* Filters */}
        <div className="card mb-4">
          <div className="card-body">
            <div className="row g-3">
              <div className="col-md-3">
                <div className="input-group">
                <span className="input-group-text">
                  <Search size={16} />
                </span>
                  <input
                      type="text"
                      className="form-control"
                      placeholder="Search RFQs..."
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                  />
                </div>
              </div>
              <div className="col-md-3">
                <select
                    className="form-select"
                    value={statusFilter}
                    onChange={(e) => setStatusFilter(e.target.value)}
                >
                  <option value="ALL">All Statuses</option>
                  <option value="NEW">New</option>
                  <option value="IN_PROGRESS">In Progress</option>
                  <option value="QUOTED">Quoted</option>
                  <option value="WON">Won</option>
                  <option value="LOST">Lost</option>
                  <option value="CANCELLED">Cancelled</option>
                  <option value="Pending Clarification">Pending Clarification</option>
                  <option value="Completed">Completed</option>
                </select>
              </div>
              <div className="col-md-3">
                <select
                    className="form-select"
                    value={priorityFilter}
                    onChange={(e) => setPriorityFilter(e.target.value)}
                >
                  <option value="ALL">All Priorities</option>
                  <option value="URGENT">Urgent</option>
                  <option value="HIGH">High</option>
                  <option value="MEDIUM">Medium</option>
                  <option value="Medium">Medium</option>
                  <option value="LOW">Low</option>
                </select>
              </div>
              <div className="col-md-3">
                <select
                    className="form-select"
                    value={entityFilter}
                    onChange={(e) => setEntityFilter(e.target.value)}
                >
                  <option value="ALL">All Entities</option>
                  <option value="ERHA FC">ERHA FC</option>
                  <option value="ERHA SS">ERHA SS</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        {/* Results Count */}
        <div className="mb-3">
          <p className="text-muted">
            Showing {filteredRfqs.length} {activeTab === 'INCOMING' ? 'incoming' : 'outgoing'} RFQ{filteredRfqs.length !== 1 ? 's' : ''}
          </p>
        </div>

        {/* RFQ Cards */}
        <div className="row g-4">
          {filteredRfqs.length === 0 ? (
              <div className="col-12">
                <div className="alert alert-warning">
                  <AlertCircle size={20} className="me-2" />
                  {searchTerm || statusFilter !== 'ALL' || priorityFilter !== 'ALL' || entityFilter !== 'ALL'
                      ? `No ${activeTab.toLowerCase()} RFQs match your filters. Try adjusting them.`
                      : `No ${activeTab.toLowerCase()} RFQs yet. Click "Create RFQ" to add one.`
                  }
                </div>
              </div>
          ) : (
              filteredRfqs.map((rfq) => (
                  <div key={rfq.id} className="col-md-6 col-lg-4">
                    <div className="card h-100">
                      <div className="card-body">
                        {/* Header with badges */}
                        <div className="d-flex justify-content-between align-items-start mb-3">
                          <div>
                            <h5 className="card-title mb-1">#{rfq.rfqNumber}</h5>
                            <span className={`badge ${rfq.operatingEntity === 'ERHA FC' ? 'bg-primary' : 'bg-success'}`}>
                        {rfq.operatingEntity}
                      </span>
                          </div>
                          <div className="text-end">
                            <div className={`badge bg-${getStatusBadge(rfq.status)} mb-1`}>
                              {rfq.status}
                            </div>
                          </div>
                        </div>

                        {/* Client & Project */}
                        <div className="mb-2">
                          <small className="text-muted">
                            {activeTab === 'INCOMING' ? 'Client' : 'Supplier'}
                          </small>
                          <p className="mb-0 fw-bold">{rfq.clientName}</p>
                        </div>
                        <div className="mb-2">
                          <small className="text-muted">Project</small>
                          <p className="mb-0">{rfq.projectName}</p>
                        </div>

                        {/* Assigned To */}
                        {rfq.assignedTo && (
                            <div className="mb-2">
                              <small className="text-muted">Assigned To</small>
                              <p className="mb-0">
                                <span className="badge bg-secondary">{rfq.assignedTo}</span>
                              </p>
                            </div>
                        )}

                        {/* Dates & Priority */}
                        <div className="row g-2 mb-3">
                          <div className="col-6">
                            <small className="text-muted d-block">Received</small>
                            <small>{rfq.receivedDate ? new Date(rfq.receivedDate).toLocaleDateString('en-ZA') : 'N/A'}</small>
                          </div>
                          <div className="col-6">
                            <small className="text-muted d-block">Required</small>
                            <small>{rfq.requiredBy ? new Date(rfq.requiredBy).toLocaleDateString('en-ZA') : 'N/A'}</small>
                          </div>
                        </div>

                        <div className="mb-3">
                          <div className="progress" style={{ height: '8px' }}>
                            <div
                                className={`progress-bar bg-${getStatusBadge(rfq.status)}`}
                                style={{ width: '100%' }}
                            ></div>
                          </div>
                          <div className="d-flex justify-content-between mt-1">
                            <small className="text-muted">{rfq.status}</small>
                            <small className={`badge bg-${getPriorityBadge(rfq.priority)}`}>
                              {rfq.priority}
                            </small>
                          </div>
                        </div>

                        {/* Estimated Value */}
                        {rfq.estimatedValue && (
                            <div className="mb-3">
                              <small className="text-muted">Estimated Value</small>
                              <p className="mb-0 fw-bold text-success">
                                R {rfq.estimatedValue.toLocaleString('en-ZA', { minimumFractionDigits: 2 })}
                              </p>
                            </div>
                        )}

                        {/* Action Buttons */}
                        <div className="d-flex gap-2">
                          <button
                              className="btn btn-outline-primary btn-sm flex-fill"
                              onClick={() => navigate(`/rfq/${rfq.id}`)}
                          >
                            <Eye size={14} className="me-1" />
                            View
                          </button>
                          <button
                              className="btn btn-outline-secondary btn-sm"
                              onClick={() => navigate(`/rfq/${rfq.id}/edit`)}
                              title="Edit RFQ"
                          >
                            <Edit size={14} />
                          </button>
                          <button
                              className="btn btn-outline-info btn-sm"
                              onClick={() => openReassignModal(rfq)}
                              title="Reassign RFQ"
                          >
                            <UserPlus size={14} />
                          </button>
                          <button
                              className="btn btn-outline-danger btn-sm"
                              onClick={() => openDeleteModal(rfq)}
                              title="Delete RFQ"
                          >
                            <Trash2 size={14} />
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
              ))
          )}
        </div>

        {/* Delete Confirmation Modal */}
        {deleteModalOpen && rfqToDelete && (
            <div className="modal show d-block" style={{ backgroundColor: 'rgba(0,0,0,0.5)' }}>
              <div className="modal-dialog modal-dialog-centered">
                <div className="modal-content">
                  <div className="modal-header">
                    <h5 className="modal-title">Delete RFQ</h5>
                    <button
                        type="button"
                        className="btn-close"
                        onClick={() => setDeleteModalOpen(false)}
                    ></button>
                  </div>
                  <div className="modal-body">
                    <p>Are you sure you want to delete this RFQ?</p>
                    <div className="alert alert-warning">
                      <strong>RFQ #{rfqToDelete.rfqNumber}</strong><br />
                      Client: {rfqToDelete.clientName}<br />
                      Project: {rfqToDelete.projectName}
                    </div>
                    <p className="text-danger mb-0">
                      <small>This action cannot be undone.</small>
                    </p>
                  </div>
                  <div className="modal-footer">
                    <button
                        type="button"
                        className="btn btn-secondary"
                        onClick={() => setDeleteModalOpen(false)}
                    >
                      Cancel
                    </button>
                    <button
                        type="button"
                        className="btn btn-danger"
                        onClick={handleDelete}
                    >
                      <Trash2 size={16} className="me-2" />
                      Delete RFQ
                    </button>
                  </div>
                </div>
              </div>
            </div>
        )}

        {/* Reassign Modal */}
        {reassignModalOpen && rfqToReassign && (
            <div className="modal show d-block" style={{ backgroundColor: 'rgba(0,0,0,0.5)' }}>
              <div className="modal-dialog modal-dialog-centered">
                <div className="modal-content">
                  <div className="modal-header">
                    <h5 className="modal-title">Reassign RFQ</h5>
                    <button
                        type="button"
                        className="btn-close"
                        onClick={() => setReassignModalOpen(false)}
                    ></button>
                  </div>
                  <div className="modal-body">
                    <p>Reassign this RFQ to a team member:</p>
                    <div className="alert alert-info">
                      <strong>RFQ #{rfqToReassign.rfqNumber}</strong><br />
                      Client: {rfqToReassign.clientName}<br />
                      Project: {rfqToReassign.projectName}<br />
                      Current: {rfqToReassign.assignedTo || 'Unassigned'}
                    </div>
                    <div className="mb-3">
                      <label className="form-label">Assign To *</label>
                      <input
                          type="text"
                          className="form-control"
                          placeholder="Enter name (e.g., John Estimator)"
                          value={newAssignee}
                          onChange={(e) => setNewAssignee(e.target.value)}
                          autoFocus
                      />
                      <small className="text-muted">Enter the name of the person to assign this RFQ to</small>
                    </div>
                  </div>
                  <div className="modal-footer">
                    <button
                        type="button"
                        className="btn btn-secondary"
                        onClick={() => setReassignModalOpen(false)}
                    >
                      Cancel
                    </button>
                    <button
                        type="button"
                        className="btn btn-primary"
                        onClick={handleReassign}
                        disabled={!newAssignee.trim()}
                    >
                      <UserPlus size={16} className="me-2" />
                      Reassign RFQ
                    </button>
                  </div>
                </div>
              </div>
            </div>
        )}
      </div>
  );
}