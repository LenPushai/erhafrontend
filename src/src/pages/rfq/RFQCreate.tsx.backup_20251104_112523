import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { ArrowLeft, Save, X } from 'lucide-react';
import rfqService from '../../services/rfqService';
import clientService from '../../services/clientService';

interface Client {
  clientId: number;
  clientName: string;
}

const RFQCreate: React.FC = () => {
  const navigate = useNavigate();
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [clients, setClients] = useState<Client[]>([]);
  const [loadingClients, setLoadingClients] = useState(true);

  const [formData, setFormData] = useState({
    // Client Information
    clientId: '',
    contactPerson: '',
    contactEmail: '',
    contactPhone: '',
    department: '',
    
    // RFQ Details
    operatingEntity: 'ERHA FC', // Default to ERHA FC
    description: '',
    requestDate: new Date().toISOString().split('T')[0], // Today
    requiredDate: '',
    priority: 'MEDIUM',
    estimatedValue: '',
    specialRequirements: '',
    
    // Assignment
    assignedTo: '',
    followUpDate: '',
    
    // Notes
    notes: '',
    remarks: ''
  });

  useEffect(() => {
    loadClients();
  }, []);

  const loadClients = async () => {
    try {
      setLoadingClients(true);
      const data = await clientService.getAllClients();
      setClients(data);
    } catch (err) {
      console.error('Failed to load clients:', err);
      setError('Failed to load clients. Please refresh the page.');
    } finally {
      setLoadingClients(false);
    }
  };

  const handleInputChange = (field: string, value: any) => {
    setFormData(prev => ({ ...prev, [field]: value }));
    setError(null); // Clear error when user makes changes
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    // Validation
    if (!formData.clientId) {
      setError('Please select a client');
      return;
    }
    if (!formData.contactPerson.trim()) {
      setError('Please enter a contact person');
      return;
    }
    if (!formData.operatingEntity) {
      setError('Please select an operating entity');
      return;
    }
    if (!formData.description.trim()) {
      setError('Please enter a description');
      return;
    }
    if (!formData.requestDate) {
      setError('Please select a request date');
      return;
    }
    if (!formData.requiredDate) {
      setError('Please select a required by date');
      return;
    }
    
    // Check that required date is after request date
    if (new Date(formData.requiredDate) < new Date(formData.requestDate)) {
      setError('Required by date must be after request date');
      return;
    }
    
    try {
      setSaving(true);
      setError(null);

      const rfqData = {
        clientId: Number(formData.clientId),
        contactPerson: formData.contactPerson.trim(),
        contactEmail: formData.contactEmail.trim() || null,
        contactPhone: formData.contactPhone.trim() || null,
        department: formData.department.trim() || null,
        operatingEntity: formData.operatingEntity,
        description: formData.description.trim(),
        requestDate: formData.requestDate,
        requiredDate: formData.requiredDate,
        priority: formData.priority,
        estimatedValue: formData.estimatedValue ? Number(formData.estimatedValue) : null,
        specialRequirements: formData.specialRequirements.trim() || null,
        assignedTo: formData.assignedTo.trim() || null,
        followUpDate: formData.followUpDate || null,
        notes: formData.notes.trim() || null,
        remarks: formData.remarks.trim() || null
      };

      await rfqService.createRFQ(rfqData);
      navigate('/rfqs');
    } catch (err: any) {
      setError(err.message || 'Failed to create RFQ');
      setSaving(false);
    }
  };

  return (
    <div className="container-fluid p-4">
      {/* Header */}
      <div className="d-flex justify-content-between align-items-center mb-4">
        <div className="d-flex align-items-center gap-3">
          <button 
            className="btn btn-outline-secondary"
            onClick={() => navigate('/rfqs')}
            disabled={saving}
          >
            <ArrowLeft size={16} />
          </button>
          <div>
            <h2 className="mb-1">Create New RFQ</h2>
            <div className="text-muted small">Request for Quotation</div>
          </div>
        </div>
      </div>

      {error && (
        <div className="alert alert-danger alert-dismissible fade show" role="alert">
          <strong>Error:</strong> {error}
          <button 
            type="button" 
            className="btn-close" 
            onClick={() => setError(null)}
          ></button>
        </div>
      )}

      <form onSubmit={handleSubmit}>
        {/* CLIENT INFORMATION CARD */}
        <div className="card mb-3">
          <div className="card-header bg-light">
            <h5 className="mb-0">Client Information</h5>
          </div>
          <div className="card-body">
            <div className="row">
              <div className="col-md-6 mb-3">
                <label className="form-label">
                  Client <span className="text-danger">*</span>
                </label>
                {loadingClients ? (
                  <div className="form-control">Loading clients...</div>
                ) : (
                  <select
                    className="form-select"
                    value={formData.clientId}
                    onChange={(e) => handleInputChange('clientId', e.target.value)}
                    required
                  >
                    <option value="">Select a client...</option>
                    {clients.map(client => (
                      <option key={client.clientId} value={client.clientId}>
                        {client.clientName}
                      </option>
                    ))}
                  </select>
                )}
              </div>

              <div className="col-md-6 mb-3">
                <label className="form-label">
                  Contact Person <span className="text-danger">*</span>
                </label>
                <input
                  type="text"
                  className="form-control"
                  value={formData.contactPerson}
                  onChange={(e) => handleInputChange('contactPerson', e.target.value)}
                  required
                  placeholder="Who requested this RFQ?"
                />
              </div>

              <div className="col-md-6 mb-3">
                <label className="form-label">Contact Email</label>
                <input
                  type="email"
                  className="form-control"
                  value={formData.contactEmail}
                  onChange={(e) => handleInputChange('contactEmail', e.target.value)}
                  placeholder="contact@email.com"
                />
              </div>

              <div className="col-md-6 mb-3">
                <label className="form-label">Contact Phone</label>
                <input
                  type="tel"
                  className="form-control"
                  value={formData.contactPhone}
                  onChange={(e) => handleInputChange('contactPhone', e.target.value)}
                  placeholder="+27 12 345 6789"
                />
              </div>

              <div className="col-md-6 mb-3">
                <label className="form-label">Department/Area</label>
                <input
                  type="text"
                  className="form-control"
                  value={formData.department}
                  onChange={(e) => handleInputChange('department', e.target.value)}
                  placeholder="e.g., MELTSHOP, MILLS"
                />
                <div className="form-text">Specific department or area within client</div>
              </div>
            </div>
          </div>
        </div>

        {/* RFQ DETAILS CARD */}
        <div className="card mb-3">
          <div className="card-header bg-light">
            <h5 className="mb-0">RFQ Details</h5>
          </div>
          <div className="card-body">
            <div className="row">
              <div className="col-md-6 mb-3">
                <label className="form-label">
                  Operating Entity <span className="text-danger">*</span>
                </label>
                <select
                  className="form-select"
                  value={formData.operatingEntity}
                  onChange={(e) => handleInputChange('operatingEntity', e.target.value)}
                  required
                >
                  <option value="ERHA FC">ERHA FC</option>
                  <option value="ERHA SS">ERHA SS</option>
                </select>
                <div className="form-text">Which ERHA entity will handle this work?</div>
              </div>

              <div className="col-md-6 mb-3">
                <label className="form-label">
                  Priority <span className="text-danger">*</span>
                </label>
                <select
                  className="form-select"
                  value={formData.priority}
                  onChange={(e) => handleInputChange('priority', e.target.value)}
                  required
                >
                  <option value="LOW">Low</option>
                  <option value="MEDIUM">Medium</option>
                  <option value="HIGH">High</option>
                  <option value="URGENT">Urgent</option>
                </select>
              </div>

              <div className="col-md-6 mb-3">
                <label className="form-label">
                  Date Received <span className="text-danger">*</span>
                </label>
                <input
                  type="date"
                  className="form-control"
                  value={formData.requestDate}
                  onChange={(e) => handleInputChange('requestDate', e.target.value)}
                  required
                />
              </div>

              <div className="col-md-6 mb-3">
                <label className="form-label">
                  Required By <span className="text-danger">*</span>
                </label>
                <input
                  type="date"
                  className="form-control"
                  value={formData.requiredDate}
                  onChange={(e) => handleInputChange('requiredDate', e.target.value)}
                  required
                  min={formData.requestDate}
                />
              </div>

              <div className="col-12 mb-3">
                <label className="form-label">
                  Description <span className="text-danger">*</span>
                </label>
                <textarea
                  className="form-control"
                  rows={4}
                  value={formData.description}
                  onChange={(e) => handleInputChange('description', e.target.value)}
                  required
                  placeholder="Detailed description of what needs to be quoted"
                />
              </div>

              <div className="col-md-6 mb-3">
                <label className="form-label">Estimated Value</label>
                <div className="input-group">
                  <span className="input-group-text">R</span>
                  <input
                    type="number"
                    className="form-control"
                    value={formData.estimatedValue}
                    onChange={(e) => handleInputChange('estimatedValue', e.target.value)}
                    min="0"
                    step="0.01"
                    placeholder="0.00"
                  />
                </div>
                <div className="form-text">Optional - your estimate of the job value</div>
              </div>

              <div className="col-md-6 mb-3">
                <label className="form-label">Assign To</label>
                <input
                  type="text"
                  className="form-control"
                  value={formData.assignedTo}
                  onChange={(e) => handleInputChange('assignedTo', e.target.value)}
                  placeholder="Team member name"
                />
              </div>

              <div className="col-12 mb-3">
                <label className="form-label">Special Requirements</label>
                <textarea
                  className="form-control"
                  rows={3}
                  value={formData.specialRequirements}
                  onChange={(e) => handleInputChange('specialRequirements', e.target.value)}
                  placeholder="Any special specifications, drawings, certifications, or requirements"
                />
              </div>

              <div className="col-md-6 mb-3">
                <label className="form-label">Follow-up Date</label>
                <input
                  type="date"
                  className="form-control"
                  value={formData.followUpDate}
                  onChange={(e) => handleInputChange('followUpDate', e.target.value)}
                  min={formData.requestDate}
                />
                <div className="form-text">When to check on quote progress</div>
              </div>
            </div>
          </div>
        </div>

        {/* ADDITIONAL NOTES CARD */}
        <div className="card mb-3">
          <div className="card-header bg-light">
            <h5 className="mb-0">Additional Notes</h5>
          </div>
          <div className="card-body">
            <div className="row">
              <div className="col-md-6 mb-3">
                <label className="form-label">Internal Notes</label>
                <textarea
                  className="form-control"
                  rows={4}
                  value={formData.notes}
                  onChange={(e) => handleInputChange('notes', e.target.value)}
                  placeholder="Internal notes for the team (not visible to client)"
                />
              </div>

              <div className="col-md-6 mb-3">
                <label className="form-label">Remarks</label>
                <textarea
                  className="form-control"
                  rows={4}
                  value={formData.remarks}
                  onChange={(e) => handleInputChange('remarks', e.target.value)}
                  placeholder="Client-facing remarks or additional information"
                />
              </div>
            </div>
          </div>
        </div>

        {/* FOOTER CARD */}
        <div className="card">
          <div className="card-footer bg-light">
            <div className="d-flex justify-content-end gap-2">
              <button
                type="button"
                className="btn btn-outline-secondary"
                onClick={() => navigate('/rfqs')}
                disabled={saving}
              >
                <X size={16} className="me-2" />
                Cancel
              </button>
              <button
                type="submit"
                className="btn btn-primary"
                disabled={saving || loadingClients}
              >
                {saving ? (
                  <>
                    <span className="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    Creating...
                  </>
                ) : (
                  <>
                    <Save size={16} className="me-2" />
                    Create RFQ
                  </>
                )}
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  );
};

export default RFQCreate;